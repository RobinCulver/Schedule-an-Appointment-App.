const express=Noderequire("express"),path=Node("path"),morgan=Node("morgan"),bodyParser=Node("body-parser"),session=Node("express-session"),cors=Node("cors"),config=Node("./config"),http=Node("http"),Cosmic=Node("cosmicjs"),twilio=Node("twilio"),moment=Node("moment"),axios=Node("axios"),app=express(),env=process.env.NODE_ENV||"development";app.set("trust proxy",1),app.use(session({secret:"sjcimsoc",resave:!1,saveUninitialized:!0,cookie:{secure:!1}})),app.use(cors()),app.use(morgan("dev")),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0})),app.use(express.static(path.join(__dirname,"public"))),app.set("port",process.env.PORT||3e3),app.post("/api/appointments",(req,res)=>{const twilioSid=config.twilio.sid,twilioAuth=config.twilio.auth,twilioClient=twilio(twilioSid,twilioAuth),twilioNumber=config.twilio.number,appointment=req.body;appointment.phone=appointment.phone.replace(/\D/g,"");const date=moment(appointment.date,"YYYY-DD-MM").startOf("day"),time=date.hour(9).add(appointment.slot,"hours"),smsBody=`${appointment.name}, this message is to confirm your appointment at ${time.format("h:mm a")} on ${date.format("dddd MMMM Do[,] YYYY")}.`;twilioClient.messages.create({to:"+1"+appointment.phone,from:twilioNumber,body:smsBody},(err,message)=>console.log(message,err));const cosmicObject={title:appointment.name,type_slug:"appointments",write_key:config.bucket.write_key,metafields:[{key:"date",type:"text",value:date.format("YYYY-DD-MM")},{key:"slot",type:"text",value:appointment.slot},{key:"email",type:"text",value:appointment.email},{key:"phone",type:"text",value:appointment.phone}]};axios.post(`https://api.cosmicjs.com/v1/${config.bucket.slug}/add-object`,cosmicObject).then(responst=>res.json({data:"succes"})).catch(err=>res.json({data:"error "}))}),app.get("/api/config",(req,res)=>{Cosmic.getObject(config,{slug:"site-config"},(err,response)=>{const data=response.object.metadata;err?res.status(500).json({data:"error"}):res.json({data:data})})}),app.get("/api/appointments",(req,res)=>{Cosmic.getObjectType(config,{type_slug:"appointments"},(err,response)=>{const appointments=response.objects.all?response.objects.all.map(appointment=>({date:appointment.metadata.date,slot:appointment.metadata.slot})):{};res.json({data:appointments})})}),app.get("/",(req,res)=>{res.send("index.html")}),app.get("*",(req,res)=>{res.redirect("/")}),http.createServer(app).listen(app.get("port"),()=>console.log("Server running at: "+app.get("port")));